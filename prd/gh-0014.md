# Default Image Fallback System

## Summary
Implement a comprehensive {default_image} fallback system that eliminates 404 errors by automatically serving a placeholder image when requested files are not found, using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing tests for each aspect of the default image system
2. **Green**: Implement minimal default image functionality to make tests pass
3. **Refactor**: Optimize fallback performance and image generation quality

### Required Tests (Write These First)
- [ ] `TestDefaultImage_Detection_ExistingJPG` - Test detection of {image_dir}/default.jpg
- [ ] `TestDefaultImage_Detection_ExistingJPEG` - Test detection of {image_dir}/default.jpeg
- [ ] `TestDefaultImage_Detection_ExistingPNG` - Test detection of {image_dir}/default.png
- [ ] `TestDefaultImage_Detection_ExistingWebP` - Test detection of {image_dir}/default.webp
- [ ] `TestDefaultImage_Detection_Priority` - Test detection priority (jpg → jpeg → png → webp)
- [ ] `TestDefaultImage_Detection_NotFound` - Test when no {default_image} exists
- [ ] `TestDefaultImage_Generation_Programmatic` - Test programmatic placeholder generation
- [ ] `TestDefaultImage_Generation_Specifications` - Test generated image meets specs (1000x1000, white bg, black text)
- [ ] `TestDefaultImage_Generation_TextCentering` - Test "goimgserver" text is properly centered
- [ ] `TestDefaultImage_Generation_FontSize` - Test font size is appropriate and readable
- [ ] `TestDefaultImage_Generation_FileFormat` - Test generated file is JPEG format with quality 95
- [ ] `TestDefaultImage_Generation_FilePath` - Test saves to {image_dir}/default.jpg
- [ ] `TestDefaultImage_Validation_Readable` - Test {default_image} is readable by image processor
- [ ] `TestDefaultImage_Validation_Processable` - Test {default_image} can be resized/converted
- [ ] `TestDefaultImage_Fallback_MissingOriginal` - Test fallback when requested image missing
- [ ] `TestDefaultImage_Fallback_SameProcessing` - Test {default_image} processed with same parameters
- [ ] `TestDefaultImage_Fallback_CacheUnderOriginal` - Test caching under original {filename}
- [ ] `TestDefaultImage_Fallback_TransparentToUser` - Test user sees no difference in response
- [ ] `TestDefaultImage_Fallback_MultipleRequests` - Test multiple requests for same missing file hit cache
- [ ] `TestDefaultImage_Error_NoWritePermission` - Test error when cannot write to {image_dir}
- [ ] `TestDefaultImage_Error_DiskSpaceFull` - Test error when insufficient disk space
- [ ] `TestDefaultImage_Error_CorruptedDefault` - Test handling of corrupted {default_image}

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] **Default Image Detection**:
  - Scan {image_dir} for default.{jpg/jpeg/png/webp} during startup
  - Use detection priority: jpg → jpeg → png → webp (first found wins)
  - Store {default_image} path in application configuration
- [ ] **Programmatic Placeholder Generation**:
  - Generate 1000x1000px image when no {default_image} found
  - White background (#FFFFFF)
  - Black text (#000000) reading "goimgserver"
  - Text centered both horizontally and vertically
  - Font size automatically calculated for optimal visibility (~130px)
  - Save as JPEG format with quality 95
  - Save to {image_dir}/default.jpg
- [ ] **Runtime Fallback Logic**:
  - When requested {filename} not found in {image_dir}, use {default_image}
  - Process {default_image} with same parameters as requested for original
  - Cache processed result under original {filename} path
  - Serve result transparently (no indication of fallback)
- [ ] **Error Elimination**:
  - Zero 404 errors for image requests
  - All image URLs return valid images
  - Graceful handling when {default_image} processing fails
- [ ] **Validation and Error Handling**:
  - Verify {default_image} is readable and processable during startup
  - Handle corrupted {default_image} by regenerating placeholder
  - Fail application startup if unable to ensure {default_image} availability
- [ ] **Test Coverage**: Achieve >95% test coverage for default image system

## Technical Details
- Use image processing library to generate programmatic placeholder
- Implement file scanning with proper error handling
- Calculate font size dynamically based on image dimensions
- Use atomic file operations when generating placeholder
- Store {default_image} path in configuration for runtime access
- Integrate with existing image processing pipeline
- **Design default image interfaces through tests first**
- Create comprehensive test fixtures for various scenarios

## Test Structure
```
src/defaultimg/
├── manager.go         # Implementation (write after tests)
├── manager_test.go    # Tests (write first)
├── generator.go       # Placeholder generation (write after tests)
├── generator_test.go  # Generator tests (write first)
├── detector.go        # Default image detection
├── detector_test.go   # Detection tests
└── testdata/
    ├── test_defaults/ # Test {default_image} files
    │   ├── default.jpg
    │   ├── default.png
    │   └── default.webp
    ├── corrupted/     # Corrupted test files
    └── expected/      # Expected generated placeholders
```

## Integration Testing Requirements
- [ ] `TestDefaultImage_Integration_StartupSequence` - Test complete startup integration
- [ ] `TestDefaultImage_Integration_RuntimeFallback` - Test runtime fallback with real HTTP requests
- [ ] `TestDefaultImage_Integration_CacheSystem` - Test integration with cache management
- [ ] `TestDefaultImage_Integration_ImageProcessor` - Test integration with image processing

## Performance Testing Requirements
- [ ] `BenchmarkDefaultImage_Generation_Speed` - Benchmark placeholder generation time
- [ ] `BenchmarkDefaultImage_Fallback_Performance` - Benchmark fallback vs. original image performance
- [ ] `BenchmarkDefaultImage_CacheHit_DefaultImage` - Benchmark cached {default_image} serving
- [ ] Test memory usage during placeholder generation

## Error Scenario Testing
- [ ] `TestDefaultImage_ErrorRecovery_CorruptedDefault` - Test recovery from corrupted {default_image}
- [ ] `TestDefaultImage_ErrorRecovery_RegeneratePlaceholder` - Test placeholder regeneration
- [ ] `TestDefaultImage_ErrorRecovery_StartupFailure` - Test startup failure scenarios
- [ ] `TestDefaultImage_ErrorRecovery_RuntimeFailure` - Test runtime fallback failures

## Dependencies
- Core configuration (gh-0002) - for {image_dir} setup and {default_image} path storage
- Image processing engine (gh-0003) - for placeholder generation and processing
- Cache management system (gh-0004) - for caching fallback images

## Priority
High - Essential for zero-404 user experience and service reliability

## TDD Success Criteria
- [ ] All tests pass including error recovery scenarios
- [ ] No production code exists without corresponding tests
- [ ] Tests cover all fallback scenarios and edge cases
- [ ] Implementation ensures zero 404 errors for image requests
- [ ] Generated placeholders meet visual quality standards
- [ ] System gracefully handles all error conditions