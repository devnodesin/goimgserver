# Image Endpoint Implementation

## Summary
Implement all image serving endpoints with URL parameter parsing for resizing, format conversion, and quality adjustment using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing HTTP handler tests for each endpoint
2. **Green**: Implement minimal HTTP handlers to make tests pass
3. **Refactor**: Optimize request handling and clean up code

### Required Tests (Write These First)
- [ ] `TestImageHandler_GET_DefaultSettings` - Test `/img/{filename}` with defaults
- [ ] `TestImageHandler_GET_WithoutExtension` - Test `/img/{filename_no_ext}` with auto-detection
- [ ] `TestImageHandler_GET_GroupedDefault` - Test `/img/{foldername}` group default access
- [ ] `TestImageHandler_GET_GroupedSpecific` - Test `/img/{foldername}/{filename}` specific image
- [ ] `TestImageHandler_GET_GroupedWithoutExtension` - Test `/img/{foldername}/{filename_no_ext}` auto-detection
- [ ] **`TestImageHandler_GET_DefaultImage_MissingFile`** - Test {default_image} fallback when {filename} not found
- [ ] **`TestImageHandler_GET_DefaultImage_ProcessingSameParams`** - Test {default_image} processed with same parameters
- [ ] **`TestImageHandler_GET_DefaultImage_CacheWithOriginalFilename`** - Test {default_image} cached under original {filename}
- [ ] `TestImageHandler_GET_CustomDimensions` - Test `/img/{filename}/{width}x{height}`
- [ ] `TestImageHandler_GET_WidthOnly` - Test `/img/{filename}/{width}`
- [ ] `TestImageHandler_GET_QualityOnly` - Test `/img/{filename}/q{quality}`
- [ ] `TestImageHandler_GET_CombinedParams` - Test `/img/{filename}/{dimensions}/q{quality}`
- [ ] `TestImageHandler_GET_FormatConversion` - Test `/img/{filename}/{dimensions}/{format}`
- [ ] `TestImageHandler_GET_AllParams` - Test `/img/{filename}/{dimensions}/{format}/q{quality}`
- [ ] `TestImageHandler_GET_CacheClear` - Test `/img/{filename}/clear`
- [ ] `TestImageHandler_GET_GroupedCacheClear` - Test `/img/{foldername}/{filename}/clear` and `/img/{foldername}/clear`
- [ ] **`TestImageHandler_GET_Never404`** - Test that no 404 errors occur (always fallback to {default_image})
- [ ] `TestImageHandler_GET_CorruptedImage` - Test 422 for corrupted images (original or {default_image})
- [ ] `TestImageHandler_Headers_ContentType` - Test correct Content-Type headers
- [ ] `TestImageHandler_Headers_CacheControl` - Test cache headers
- [ ] `TestImageHandler_Headers_CORS` - Test CORS headers
- [ ] **`TestParseImageRequest_GracefulParsing_ValidParams`** - Test graceful parsing of valid parameters
- [ ] **`TestParseImageRequest_GracefulParsing_InvalidParamsIgnored`** - Test invalid parameters are ignored
- [ ] **`TestParseImageRequest_GracefulParsing_DuplicateParamsFirstWins`** - Test first valid parameter wins
- [ ] **`TestParseImageRequest_GracefulParsing_InvalidValuesUseDefaults`** - Test fallback to defaults
- [ ] **`TestParseImageRequest_GracefulParsing_ComplexURL`** - Test complex URL with mixed valid/invalid params
- [ ] **`TestParseImageRequest_GracefulParsing_ParameterOrder`** - Test parameter order independence
- [ ] **`TestParseImageRequest_GracefulParsing_EdgeCases`** - Test edge cases and boundary values
- [ ] **`TestParseImageRequest_GracefulParsing_Performance`** - Test parsing performance with many parameters

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] `GET /img/{filename}` - Default settings (1000x1000px, q75, WebP)
- [ ] `GET /img/{filename_no_ext}` - Auto-detect file extension following priority order (jpg/jpeg > png > webp)
- [ ] `GET /img/{foldername}` - Group default image access (serves {foldername}/default.*)
- [ ] `GET /img/{foldername}/{filename}` - Specific grouped image access
- [ ] `GET /img/{foldername}/{filename_no_ext}` - Grouped image with auto-detection
- [ ] `GET /img/{filename}/{width}x{height}` - Custom dimensions
- [ ] `GET /img/{filename}/{width}` - Width only (maintain aspect ratio)
- [ ] `GET /img/{filename}/q{quality}` - Quality adjustment
- [ ] `GET /img/{filename}/{dimensions}/q{quality}` - Combined parameters
- [ ] `GET /img/{filename}/{dimensions}/{format}` - Format conversion
- [ ] `GET /img/{filename}/{dimensions}/{format}/q{quality}` - All parameters
- [ ] `GET /img/{filename}/clear` - Clear cache for specific file
- [ ] `GET /img/{foldername}/clear` - Clear cache for group default
- [ ] `GET /img/{foldername}/{filename}/clear` - Clear cache for specific grouped image
- [ ] **{default_image} Fallback System**: Implement zero-404 fallback mechanism:
  - **When {filename} not found**: Automatically serve {default_image} from {image_dir}/default.{jpg/jpeg/png/webp}
  - **When grouped image not found**: Fallback to group default, then system default
  - **Same processing applied**: Process {default_image} with same parameters as requested for original
  - **Cache under original path**: Store processed {default_image} in cache using original request path
  - **Transparent to user**: No indication that fallback was used (same URL, same result)
  - **Eliminate 404 errors**: All image requests return valid images
- [ ] **Graceful URL Parsing**: Implement fault-tolerant parameter parsing:
  - **Invalid parameters ignored**: `/img/photo.jpg/800x600/webp/q90/wow` ignores `wow`
  - **First valid parameter wins**: `/img/logo.png/300/400/jpeg/q85` uses `300` for width, ignores `400`
  - **Duplicate types use first**: `/img/logo.png/300/png/jpeg/q85` uses `png`, ignores `jpeg`
  - **Invalid values use defaults**: `/img/banner.jpg/1200x400/png/q95005` uses default quality (`q75`)
  - **Parameter order independence**: Any order of valid parameters works
- [ ] Proper HTTP headers (Content-Type, Cache-Control, ETag)
- [ ] Error handling for corrupted images (422) - **Note**: Missing files no longer generate errors due to {default_image} fallback
- [ ] CORS support as specified in design
- [ ] **Test Coverage**: Achieve >95% test coverage for handlers package including graceful parsing and {default_image} fallback

## Technical Details
- Use Gin's parameter binding for URL parsing
- **Implement graceful parameter parsing strategy** as defined in `design/url-parsing.md`:
  - Parse URL segments in order, recognizing parameter patterns
  - Ignore unrecognized parameters (fault tolerance)
  - Use first valid parameter when duplicates exist
  - Fall back to defaults for invalid parameter values
  - Never generate HTTP errors for parameter parsing issues
- Set appropriate HTTP response headers for caching
- Handle various combinations of parameters gracefully with parameter order independence
- Return proper HTTP status codes (200, 404, 422, 500) - **No 400 errors for invalid parameters**
- Add request logging for debugging including ignored parameters
- **Design handler interfaces through tests first**
- Use dependency injection for testability

## Test Structure
```
src/handlers/
├── image.go           # Implementation (write after tests)
├── image_test.go      # Tests (write first)
├── params.go          # Graceful parameter parsing logic
├── params_test.go     # Parameter parsing tests (focus on graceful parsing)
├── middleware.go      # HTTP middleware
├── middleware_test.go # Middleware tests
└── testdata/
    ├── test_images/   # Test image files
    └── sample_urls.txt # Sample URLs for testing graceful parsing
```

## HTTP Testing Requirements
- [ ] Use `httptest` package for testing HTTP handlers
- [ ] Test request/response cycles with real HTTP requests
- [ ] Mock image processor and cache manager for unit tests
- [ ] Test concurrent request handling
- [ ] Test request timeout handling
- [ ] **Test graceful parsing with complex URLs containing invalid parameters**

## Graceful Parsing Testing Requirements
- [ ] `TestGracefulParsing_InvalidParametersIgnored` - Test URLs like `/img/photo.jpg/800x600/webp/q90/wow`
- [ ] `TestGracefulParsing_DuplicateParameters` - Test URLs like `/img/logo.png/300/400/jpeg/png/q85`
- [ ] `TestGracefulParsing_InvalidValues` - Test URLs like `/img/banner.jpg/99999x1/q95005`
- [ ] `TestGracefulParsing_MixedValidInvalid` - Test complex URLs with mix of valid/invalid params
- [ ] `TestGracefulParsing_EmptySegments` - Test URLs with empty segments
- [ ] `TestGracefulParsing_SpecialCharacters` - Test URLs with special characters in parameters

## Integration Testing Requirements
- [ ] `TestImageEndpoint_Integration_CompleteFlow` - Test complete image processing flow
- [ ] `TestImageEndpoint_Integration_CacheHit` - Test cached image serving
- [ ] `TestImageEndpoint_Integration_CacheMiss` - Test new image processing
- [ ] Test with actual image files and cache operations

## Performance Testing Requirements
- [ ] `BenchmarkImageHandler_CacheHit` - Benchmark cached image serving
- [ ] `BenchmarkImageHandler_CacheMiss` - Benchmark new image processing
- [ ] `BenchmarkParseImageRequest` - Benchmark parameter parsing
- [ ] Load testing with concurrent requests

## Dependencies
- Core configuration (gh-0002)
- Image processing engine (gh-0003)
- Cache management system (gh-0004)
- File resolution system (gh-0015)

## Priority
High - Primary user-facing functionality

## TDD Success Criteria
- [ ] All tests pass including integration tests
- [ ] No production code exists without corresponding tests
- [ ] Tests cover all HTTP status codes and error scenarios
- [ ] Implementation is minimal and focused on making tests pass
- [ ] HTTP handlers are properly structured and testable