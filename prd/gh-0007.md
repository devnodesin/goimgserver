# Pre-cache Initialization System

## Summary
Implement the startup pre-caching system that scans the images directory and creates default cached versions of all images during application startup using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing tests for pre-cache scanning and processing
2. **Green**: Implement minimal directory scanning and caching logic
3. **Refactor**: Optimize performance and add concurrent processing

### Required Tests (Write These First)
- [ ] `TestPreCache_ScanDirectory_EmptyDirectory` - Test empty {image_dir}
- [ ] `TestPreCache_ScanDirectory_SingleImage` - Test single image processing
- [ ] `TestPreCache_ScanDirectory_MultipleImages` - Test multiple image processing
- [ ] `TestPreCache_ScanDirectory_NestedDirectories` - Test recursive directory scanning
- [ ] `TestPreCache_ScanDirectory_UnsupportedFiles` - Test non-image file handling
- [ ] `TestPreCache_ScanDirectory_CorruptedImages` - Test corrupted image handling
- [ ] **`TestPreCache_ScanDirectory_ExcludeDefaultImage`** - Test {default_image} is not pre-cached (avoid double processing)
- [ ] **`TestPreCache_ProcessImage_WithDefaultImageFallback`** - Test pre-caching when {default_image} system is available
- [ ] `TestPreCache_ProcessImage_DefaultSettings` - Test default cache creation (1000x1000, WebP, q95)
- [ ] `TestPreCache_ProcessImage_AlreadyCached` - Test skip already cached images
- [ ] `TestPreCache_ProcessImage_CacheCreation` - Test cache directory creation
- [ ] `TestPreCache_ProcessImage_ErrorHandling` - Test processing error handling
- [ ] `TestPreCache_Progress_Tracking` - Test progress reporting
- [ ] `TestPreCache_Progress_Logging` - Test progress logging
- [ ] `TestPreCache_Concurrent_Processing` - Test concurrent image processing
- [ ] `TestPreCache_Concurrent_ThreadSafety` - Test thread safety
- [ ] `TestPreCache_Startup_Integration` - Test integration with app startup
- [ ] `TestPreCache_Configuration_Optional` - Test making pre-cache optional
- [ ] `TestPreCache_Performance_LargeDirectory` - Test performance with many images

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] Scan {image_dir} for supported image files during startup
- [ ] **Exclude {default_image}**: Skip pre-caching of {default_image} file to avoid redundant processing
- [ ] Create default cached versions for each image (excluding {default_image}):
  - Dimensions: 1000x1000px
  - Format: WebP
  - Quality: q95
- [ ] Store pre-cached images in proper cache directory structure: {cache_dir}/{filename}/{hash}
- [ ] Add progress tracking and structured logging during pre-cache process
- [ ] Handle errors gracefully (skip corrupted images, log issues)
- [ ] Make pre-caching optional or configurable via CLI flag
- [ ] Support for nested directories in {image_dir}
- [ ] Skip already cached images to avoid redundant processing
- [ ] **Integration with {default_image} system**: Ensure pre-caching works correctly when {default_image} fallback is available
- [ ] **Test Coverage**: Achieve >95% test coverage for pre-cache package

## Technical Details
- Recursively scan images directory for supported file types
- Use worker pools or goroutines for parallel processing
- Implement proper error handling for each image
- Add startup time optimization (don't block server start for too long)
- Consider making this process asynchronous or optional
- Support common image formats (JPEG, PNG, WebP, etc.)
- **Design pre-cache interfaces through tests first**
- Use channels for progress reporting and coordination

## Test Structure
```
src/precache/
├── scanner.go         # Implementation (write after tests)
├── scanner_test.go    # Tests (write first)
├── processor.go       # Pre-cache processing logic
├── processor_test.go  # Processing tests
├── progress.go        # Progress tracking
├── progress_test.go   # Progress tests
└── testdata/
    ├── images/        # Test image directory structure
    │   ├── photo1.jpg
    │   ├── photo2.png
    │   ├── subdir/
    │   │   └── photo3.webp
    │   └── corrupted.jpg
    └── expected_cache/ # Expected cache structure
```

## Concurrent Processing Testing
- [ ] `TestPreCache_Concurrent_WorkerPool` - Test worker pool implementation
- [ ] `TestPreCache_Concurrent_ResourceLimits` - Test resource usage limits
- [ ] `TestPreCache_Concurrent_ErrorHandling` - Test error handling in concurrent context
- [ ] `TestPreCache_Concurrent_Cancellation` - Test graceful cancellation

## Performance Testing Requirements
- [ ] `BenchmarkPreCache_ScanDirectory_SmallSet` - Benchmark small image set
- [ ] `BenchmarkPreCache_ScanDirectory_LargeSet` - Benchmark large image set
- [ ] `BenchmarkPreCache_ProcessImage_Sequential` - Benchmark sequential processing
- [ ] `BenchmarkPreCache_ProcessImage_Concurrent` - Benchmark concurrent processing
- [ ] Memory usage profiling for large image sets

## Integration Testing Requirements
- [ ] `TestPreCache_Integration_RealImages` - Test with real image files
- [ ] `TestPreCache_Integration_CacheCreation` - Test actual cache creation
- [ ] `TestPreCache_Integration_StartupFlow` - Test integration with app startup

## Dependencies
- Core configuration (gh-0002)
- Image processing engine (gh-0003)
- Cache management system (gh-0004)

## Priority
Medium - Performance optimization, but not critical for basic functionality

## TDD Success Criteria
- [ ] All tests pass including concurrent processing tests
- [ ] No production code exists without corresponding tests
- [ ] Tests cover error scenarios and edge cases
- [ ] Implementation handles concurrent processing safely
- [ ] Pre-cache process is configurable and doesn't block startup