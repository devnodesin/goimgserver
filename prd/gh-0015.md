# File Resolution System Implementation

## Summary
Implement comprehensive file resolution system that supports extension auto-detection, grouped image organization, and extension priority ordering using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing tests for each file resolution capability
2. **Green**: Implement minimal file system operations to make tests pass
3. **Refactor**: Optimize resolution performance and clean up code

### Required Tests (Write These First)
- [ ] `TestFileResolver_New_ValidInstance` - Test resolver creation
- [ ] `TestFileResolver_ResolveSingle_WithExtension` - Test direct file resolution
- [ ] `TestFileResolver_ResolveSingle_WithoutExtension` - Test extension auto-detection
- [ ] `TestFileResolver_ResolveSingle_ExtensionPriority` - Test jpg > png > webp priority
- [ ] `TestFileResolver_ResolveSingle_MultipleExtensions` - Test priority with multiple files
- [ ] `TestFileResolver_ResolveGrouped_DefaultImage` - Test group default resolution
- [ ] `TestFileResolver_ResolveGrouped_SpecificImage` - Test specific grouped image resolution
- [ ] `TestFileResolver_ResolveGrouped_WithExtension` - Test grouped image with extension
- [ ] `TestFileResolver_ResolveGrouped_WithoutExtension` - Test grouped auto-detection
- [ ] `TestFileResolver_ResolveGrouped_MissingFallback` - Test fallback to group default
- [ ] `TestFileResolver_PathTraversal_Prevention` - Test security path validation
- [ ] `TestFileResolver_SymlinkHandling_Safe` - Test safe symlink following
- [ ] `TestFileResolver_SymlinkHandling_Dangerous` - Test dangerous symlink rejection
- [ ] `TestFileResolver_CacheResolution_Performance` - Test resolution caching
- [ ] `TestFileResolver_FileSystemWatcher_Integration` - Test file change detection
- [ ] `TestFileResolver_Concurrent_ThreadSafety` - Test thread-safe operations

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] **Extension Auto-Detection**: Support requests without file extensions
  - `GET /img/cat` → searches for `cat.jpg`, `cat.png`, `cat.webp` in priority order
  - Return first match following extension priority
- [ ] **Extension Priority Order**: When multiple extensions exist for same base filename:
  - **Priority**: jpg/jpeg (highest) > png (medium) > webp (lowest)
  - **Example**: If `profile.jpg`, `profile.png`, `profile.webp` exist, serve `profile.jpg`
- [ ] **Grouped Image Support**: Organize images in folders with default fallback
  - `GET /img/cats` → resolves to `{image_dir}/cats/default.*` (following extension priority)
  - `GET /img/cats/cat_white` → resolves to `{image_dir}/cats/cat_white.*` (following extension priority)
  - `GET /img/cats/cat_white.jpg` → resolves to `{image_dir}/cats/cat_white.jpg` (direct match)
- [ ] **Fallback Chain Implementation**: Structured fallback system
  - Single image: requested file → system default → generated placeholder
  - Grouped image: specific file → group default → system default → generated placeholder
- [ ] **Path Security**: Prevent path traversal and ensure files stay within {image_dir}
- [ ] **Symlink Safety**: Follow symlinks only if they point within {image_dir}
- [ ] **Performance Optimization**: Cache resolution results and use file system watchers
- [ ] **Integration with URL Parsing**: Work seamlessly with graceful parameter parsing system
- [ ] **Cache Path Generation**: Generate appropriate cache paths based on resolved files
- [ ] **Error Handling**: Handle file system errors gracefully with appropriate fallbacks
- [ ] **Test Coverage**: Achieve >95% test coverage for resolution package

## Technical Details

### File Organization Patterns

#### Single Images (Traditional)
```
{image_dir}/
├── cat.jpg                    # /img/cat.jpg or /img/cat
├── dog.png                    # /img/dog.png or /img/dog  
├── profile.jpg                # /img/profile → profile.jpg (priority)
├── profile.png                # Lower priority than profile.jpg
└── default.jpg                # System default image
```

#### Grouped Images
```
{image_dir}/
├── cats/
│   ├── default.jpg            # /img/cats
│   ├── cat_white.jpg          # /img/cats/cat_white
│   ├── funny_white.png        # /img/cats/funny_white
│   └── cute_cat.webp          # /img/cats/cute_cat
├── dogs/
│   ├── default.png            # /img/dogs
│   └── puppy.jpg              # /img/dogs/puppy
└── default.jpg                # System default
```

### Resolution Algorithm Implementation
- **Path Parsing**: Extract base path and determine if single or grouped image
- **Extension Detection**: For paths without extensions, search in priority order
- **Directory Validation**: Check if path segments represent valid directories
- **Security Validation**: Ensure resolved paths stay within {image_dir}
- **Fallback Logic**: Implement structured fallback chain
- **Cache Integration**: Generate cache paths based on resolved file paths

### Performance Requirements
- **Resolution Caching**: Cache successful resolutions in memory
- **File System Watching**: Monitor {image_dir} for changes and invalidate cache
- **Batch Operations**: Optimize directory scanning during startup
- **Concurrent Safety**: Thread-safe resolution operations

## Test Structure
```
src/resolver/
├── resolver.go         # Implementation (write after tests)
├── resolver_test.go    # Tests (write first)
├── types.go           # Resolution types and interfaces
├── cache.go           # Resolution caching logic
├── cache_test.go      # Cache tests
├── security.go        # Path security validation
├── security_test.go   # Security tests
└── testdata/
    ├── test_images/   # Test image directory structure
    └── test_cases/    # Test case configurations
```

## Integration Testing Requirements
- [ ] `TestFileResolver_Integration_URLParsing` - Test integration with URL parsing
- [ ] `TestFileResolver_Integration_CacheGeneration` - Test cache path generation
- [ ] `TestFileResolver_Integration_DefaultImageFallback` - Test default image integration
- [ ] `TestFileResolver_Integration_CompleteFlow` - Test complete resolution flow

## Performance Testing Requirements
- [ ] `BenchmarkFileResolver_SingleImage_WithExtension` - Benchmark direct resolution
- [ ] `BenchmarkFileResolver_SingleImage_AutoDetection` - Benchmark auto-detection
- [ ] `BenchmarkFileResolver_GroupedImage_Default` - Benchmark group default resolution
- [ ] `BenchmarkFileResolver_GroupedImage_Specific` - Benchmark specific grouped image
- [ ] `BenchmarkFileResolver_CacheHit` - Benchmark cached resolution
- [ ] `BenchmarkFileResolver_CacheMiss` - Benchmark uncached resolution

## Security Testing Requirements
- [ ] `TestFileResolver_Security_PathTraversal` - Test path traversal prevention
- [ ] `TestFileResolver_Security_SymlinkAttack` - Test symlink attack prevention
- [ ] `TestFileResolver_Security_DirectoryEscape` - Test directory escape prevention
- [ ] `TestFileResolver_Security_NullByteInjection` - Test null byte injection prevention

## Dependencies
- Core configuration system (gh-0002)
- Default image system (via integration, not direct dependency)

## Priority
High - Essential for new file access patterns

## TDD Success Criteria
- [ ] All tests pass including security and performance tests
- [ ] No production code exists without corresponding tests
- [ ] Tests cover all resolution scenarios and edge cases
- [ ] Implementation is minimal and focused on making tests pass
- [ ] File resolution operations are secure and performant
- [ ] Integration with existing systems works seamlessly

## API Impact
This implementation enables new URL patterns:
- `GET /img/cat` (auto-detects cat.jpg, cat.png, or cat.webp)
- `GET /img/cats` (serves cats/default.*)
- `GET /img/cats/cat_white` (serves cats/cat_white.*)
- `GET /img/cats/cat_white/300x300/webp` (with processing parameters)

All existing URL patterns remain fully compatible.