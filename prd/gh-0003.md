# Image Processing Engine with bimg Integration

## Summary
Implement the core image processing functionality using the bimg library (libvips wrapper) to handle resizing, format conversion, and quality adjustment using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing tests for each image processing capability
2. **Green**: Implement minimal code using bimg to make tests pass
3. **Refactor**: Optimize performance and clean up code while maintaining tests

### Required Tests (Write These First)
- [ ] `TestImageProcessor_New_ValidInstance` - Test processor creation
- [ ] `TestImageProcessor_Resize_ValidDimensions` - Test basic resizing
- [ ] `TestImageProcessor_Resize_MaintainAspectRatio` - Test single dimension resize
- [ ] `TestImageProcessor_Resize_MinimumConstraints` - Test 10px minimum limit
- [ ] `TestImageProcessor_Resize_MaximumConstraints` - Test 4000px maximum limit
- [ ] `TestImageProcessor_ConvertFormat_WebP` - Test WebP conversion
- [ ] `TestImageProcessor_ConvertFormat_PNG` - Test PNG conversion  
- [ ] `TestImageProcessor_ConvertFormat_JPEG` - Test JPEG conversion
- [ ] `TestImageProcessor_ConvertFormat_UnsupportedFormat` - Test error handling
- [ ] `TestImageProcessor_AdjustQuality_ValidRange` - Test quality 1-100
- [ ] `TestImageProcessor_AdjustQuality_InvalidRange` - Test quality validation
- [ ] `TestImageProcessor_Process_CombinedOperations` - Test resize + format + quality
- [ ] `TestImageProcessor_Process_CorruptedImage` - Test error handling
- [ ] `TestImageProcessor_Process_UnsupportedInputFormat` - Test input validation
- [ ] `TestImageProcessor_Validate_ImageHeaders` - Test file type validation

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] Add bimg dependency to go.mod
- [ ] Create image processing service/module with clean interface
- [ ] Implement image resizing with dimensions:
  - Support `{width}x{height}` format
  - Support single dimension (maintaining aspect ratio)
  - Enforce minimum (10px) and maximum (4000px) constraints
  - Default to 1000x1000px
- [ ] Implement format conversion:
  - Support WebP (default), PNG, JPEG
  - Handle format-specific optimization
- [ ] Implement quality control:
  - Support `qXX` format (e.g., q95, q75)
  - Default to q75
  - Validate quality range (1-100)
- [ ] Add error handling for unsupported formats and invalid images
- [ ] Add validation for image file types using magic numbers
- [ ] **Test Coverage**: Achieve >95% test coverage for processor package

## Technical Details
- Use `github.com/h2non/bimg` for image processing
- Create reusable image processing functions with clean interfaces
- Handle memory management properly with bimg
- Add comprehensive error handling for various image processing failures
- Support common input formats (JPEG, PNG, WebP, etc.)
- **Design interfaces through tests first**
- Create test image fixtures in multiple formats and sizes

## Test Structure
```
src/processor/
├── image.go           # Implementation (write after tests)
├── image_test.go      # Tests (write first)
├── types.go           # Types and interfaces
└── testdata/
    ├── sample.jpg     # Test fixtures
    ├── sample.png
    ├── sample.webp
    ├── large.jpg      # For performance tests
    ├── small.png      # For edge cases
    └── corrupted.jpg  # For error testing
```

## Performance Testing Requirements
- [ ] `BenchmarkImageProcessor_Resize_SmallImage` - Benchmark small image processing
- [ ] `BenchmarkImageProcessor_Resize_LargeImage` - Benchmark large image processing
- [ ] `BenchmarkImageProcessor_ConvertFormat_WebP` - Benchmark WebP conversion
- [ ] Memory usage tests for large image processing

## Dependencies
- Requires libvips to be installed on the system
- Foundation configuration (gh-0002)

## Priority
High - Core functionality required for image serving

## TDD Success Criteria
- [ ] All tests pass
- [ ] No production code exists without corresponding tests
- [ ] Tests cover all error scenarios and edge cases
- [ ] Implementation is minimal and focused on making tests pass
- [ ] Performance benchmarks meet requirements