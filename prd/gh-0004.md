# Cache Management System

## Summary
Implement a comprehensive caching system that stores processed images in a structured directory format and provides cache lookup, storage, and management capabilities using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing tests for each cache operation
2. **Green**: Implement minimal file system operations to make tests pass
3. **Refactor**: Optimize cache performance and clean up code

### Required Tests (Write These First)
- [ ] `TestCacheManager_New_ValidInstance` - Test cache manager creation
- [ ] `TestCacheManager_GenerateKey_ConsistentHash` - Test hash generation consistency
- [ ] `TestCacheManager_GenerateKey_DifferentParams` - Test different params create different hashes
- [ ] `TestCacheManager_GenerateKey_SameParams` - Test same params create same hash
- [ ] **`TestCacheManager_GenerateKey_DefaultImageFallback`** - Test cache keys when {default_image} is used
- [ ] **`TestCacheManager_Store_DefaultImageCacheUnderOriginal`** - Test {default_image} cached under original {filename}
- [ ] **`TestCacheManager_Retrieve_DefaultImageFromCache`** - Test retrieving cached {default_image} by original {filename}
- [ ] `TestCacheManager_Store_ValidData` - Test successful cache storage
- [ ] `TestCacheManager_Store_CreateDirectoryStructure` - Test directory creation
- [ ] `TestCacheManager_Store_AtomicWrite` - Test atomic file operations
- [ ] `TestCacheManager_Retrieve_ExistingFile` - Test cache hit
- [ ] `TestCacheManager_Retrieve_MissingFile` - Test cache miss
- [ ] `TestCacheManager_Retrieve_CorruptedFile` - Test corrupted cache handling
- [ ] `TestCacheManager_Exists_ValidFile` - Test file existence check
- [ ] `TestCacheManager_Clear_SpecificFile` - Test single file cache clear
- [ ] `TestCacheManager_Clear_AllFiles` - Test global cache clear
- [ ] `TestCacheManager_Clear_NonExistentFile` - Test clearing non-existent files
- [ ] `TestCacheManager_GetPath_ValidStructure` - Test cache path generation
- [ ] `TestCacheManager_GetStats_FileCount` - Test cache statistics
- [ ] `TestCacheManager_Concurrent_SafeOperations` - Test thread safety

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] Implement cache directory structure: {cache_dir}/{filename}/{hash}
- [ ] Create hash generation based on processing parameters (dimensions, format, quality)
- [ ] **Default Image Cache Behavior**: When {default_image} is served due to missing {filename}:
  - Cache the processed {default_image} under the **original {filename}** path
  - Use same cache key generation as if original image was processed
  - Ensure cache hits for repeated requests of same missing file
  - Maintain cache consistency regardless of image source (original vs. {default_image})
- [ ] Implement cache lookup functionality with fast path optimization
- [ ] Implement cache storage functionality with atomic operations
- [ ] Add cache validation (check if cached file exists and is valid)
- [ ] Implement cache clearing for specific files (including {default_image} cached under various {filename}s)
- [ ] Implement global cache clearing with progress reporting
- [ ] Add cache statistics and metrics (hit/miss rates, file counts, sizes, {default_image} usage stats)
- [ ] Handle file system permissions and errors gracefully
- [ ] Implement atomic file operations to prevent corruption
- [ ] **Test Coverage**: Achieve >95% test coverage for cache package

## Technical Details
- Use cryptographic hash (e.g., SHA256) for cache keys based on filename + **normalized parameters only**
- **Cache key generation**: Only use final parsed/normalized parameters (ignore invalid/duplicate parameters)
- **Consistent cache hits**: URLs with different invalid parameters but same valid parameters should hit same cache
- Examples of cache key consistency:
  - `/img/photo.jpg/800x600/webp/q90` and `/img/photo.jpg/800x600/webp/q90/invalid` → same cache key
  - `/img/logo.png/300/400/png/q85` and `/img/logo.png/300/png/q85` → same cache key (both resolve to width=300, format=png, quality=85)
- Ensure thread-safe cache operations using appropriate synchronization
- Handle concurrent access to cache files with proper locking
- Add proper file locking if necessary for atomic operations
- Include cache metadata (creation time, size, parameters used - normalized parameters only)
- Implement cache cleanup strategies for old/unused files
- **Design cache interface through tests first**
- Use dependency injection for file system operations to enable testing

## Test Structure
```
src/cache/
├── manager.go         # Implementation (write after tests)
├── manager_test.go    # Tests (write first)
├── types.go           # Cache types and interfaces
├── hash.go            # Hash generation logic
├── hash_test.go       # Hash tests
└── testdata/
    ├── test_cache/    # Test cache directory
    └── sample_files/  # Test files for caching
```

## Performance Testing Requirements
- [ ] `BenchmarkCacheManager_Store_SmallFile` - Benchmark small file storage
- [ ] `BenchmarkCacheManager_Store_LargeFile` - Benchmark large file storage
- [ ] `BenchmarkCacheManager_Retrieve_Hit` - Benchmark cache retrieval
- [ ] `BenchmarkCacheManager_GenerateKey` - Benchmark hash generation
- [ ] Concurrent access performance tests

## Concurrency Testing Requirements
- [ ] `TestCacheManager_Concurrent_MultipleWrites` - Test concurrent writes to same file
- [ ] `TestCacheManager_Concurrent_ReadWrite` - Test concurrent read/write operations
- [ ] `TestCacheManager_Concurrent_ClearOperations` - Test concurrent clear operations

## Dependencies
- Core configuration system (gh-0002)
- Image processing engine (gh-0003)

## Priority
High - Essential for performance optimization

## TDD Success Criteria
- [ ] All tests pass including concurrent access tests
- [ ] No production code exists without corresponding tests
- [ ] Tests cover all error scenarios, edge cases, and race conditions
- [ ] Implementation is minimal and focused on making tests pass
- [ ] Cache operations are atomic and thread-safe