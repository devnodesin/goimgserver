# Command Endpoints Implementation

## Summary
Implement administrative command endpoints for cache management and Git operations using Test-Driven Development (TDD).

## TDD Requirements
**MANDATORY**: Follow TDD Red-Green-Refactor cycle for all implementation.

### Test-First Development Steps
1. **Red**: Write failing tests for each command endpoint
2. **Green**: Implement minimal command execution to make tests pass
3. **Refactor**: Add security and optimize command handling

### Required Tests (Write These First)
- [ ] `TestCommandHandler_POST_Clear_Success` - Test successful cache clear
- [ ] `TestCommandHandler_POST_Clear_EmptyCache` - Test clearing empty cache
- [ ] `TestCommandHandler_POST_Clear_PermissionError` - Test permission errors
- [ ] `TestCommandHandler_POST_GitUpdate_ValidRepo` - Test git update in valid repo
- [ ] `TestCommandHandler_POST_GitUpdate_NotGitRepo` - Test non-git directory
- [ ] `TestCommandHandler_POST_GitUpdate_GitNotFound` - Test missing git binary
- [ ] `TestCommandHandler_POST_GitUpdate_NetworkError` - Test network failures
- [ ] `TestCommandHandler_POST_GenericCommand_ValidName` - Test generic command framework
- [ ] `TestCommandHandler_POST_GenericCommand_InvalidName` - Test invalid commands
- [ ] `TestCommandHandler_Authentication_ValidToken` - Test authentication
- [ ] `TestCommandHandler_Authentication_InvalidToken` - Test auth failures
- [ ] `TestCommandHandler_Authentication_MissingToken` - Test missing auth
- [ ] `TestGitOperations_IsGitRepo_ValidRepo` - Test git repo detection
- [ ] `TestGitOperations_IsGitRepo_NotGitRepo` - Test non-git directory
- [ ] `TestGitOperations_ExecuteGitPull_Success` - Test successful git pull
- [ ] `TestGitOperations_ExecuteGitPull_Timeout` - Test command timeout
- [ ] `TestCommandExecution_Timeout_LongRunning` - Test command timeouts
- [ ] `TestCommandExecution_Security_InjectionPrevention` - Test injection protection

## Acceptance Criteria
- [ ] **TDD Cycle**: All tests written before implementation code
- [ ] `POST /cmd/clear` - Clear entire cache directory
- [ ] `POST /cmd/gitupdate` - Execute git pull in images directory (if it's a git repo)
- [ ] `POST /cmd/{name}` - Generic command execution framework
- [ ] Proper authentication/authorization for admin commands (security consideration)
- [ ] Command execution logging and error handling
- [ ] Response with operation status and results in JSON format
- [ ] Git repository detection and validation
- [ ] Safe command execution with timeouts and injection prevention
- [ ] **Test Coverage**: Achieve >95% test coverage for command handlers

## Technical Details
- Implement secure command execution to prevent injection attacks
- Add proper error handling and structured logging for each command
- Validate that images directory is a git repository before git operations
- Use Go's `os/exec` package for git commands with proper timeout handling
- Consider adding basic authentication or API key protection
- Return structured JSON responses with operation status
- **Design command interfaces through tests first**
- Use dependency injection for external command execution

## Test Structure
```
src/handlers/
├── command.go         # Implementation (write after tests)
├── command_test.go    # Tests (write first)
└── testdata/
    ├── test_git_repo/ # Mock git repository for testing
    └── test_cache/    # Test cache directory
src/git/
├── operations.go      # Git operations (write after tests)
├── operations_test.go # Git tests (write first)
└── testdata/
    └── sample_repo/   # Test git repository
```

## Security Testing Requirements
- [ ] `TestCommandSecurity_SQLInjection_Prevention` - Test SQL injection prevention
- [ ] `TestCommandSecurity_CommandInjection_Prevention` - Test command injection prevention
- [ ] `TestCommandSecurity_PathTraversal_Prevention` - Test path traversal prevention
- [ ] `TestCommandAuthentication_TokenValidation` - Test token validation
- [ ] `TestCommandAuthorization_RoleBasedAccess` - Test role-based access

## Integration Testing Requirements
- [ ] `TestCommandEndpoint_Integration_CacheClear` - Test actual cache clearing
- [ ] `TestCommandEndpoint_Integration_GitUpdate` - Test actual git operations
- [ ] Test with real file system operations
- [ ] Test command execution timeouts with real processes

## Performance Testing Requirements
- [ ] `BenchmarkCommandHandler_CacheClear` - Benchmark cache clearing performance
- [ ] `BenchmarkCommandHandler_GitUpdate` - Benchmark git operations
- [ ] Test concurrent command execution limits

## Dependencies
- Core configuration (gh-0002)
- Cache management system (gh-0004)

## Priority
Medium - Administrative functionality, important for maintenance

## TDD Success Criteria
- [ ] All tests pass including security and integration tests
- [ ] No production code exists without corresponding tests
- [ ] Tests cover all security scenarios and error conditions
- [ ] Implementation prevents command injection and other security issues
- [ ] Command execution is properly isolated and timed out